---
title: "modelConstruction"
author: "Ruth Walters"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
mobility <- read.csv("mobility-all.csv", header = TRUE)

library(ggplot2)
library(dplyr)
library(corrplot)
library(tidyr)
library(cowplot)
library(ggpubr)

theme_set(theme_bw())
theme_update(
  axis.title.x = element_blank(),  
  axis.title.y = element_blank(), 
  plot.title = element_text(size = 12, face = "italic")
)
```
## From datacamp
[https://www.datacamp.com/tutorial/linear-regression-R][How to Do Linear Regression in R]
 
> "When a regression takes into account two or more predictors to create the linear regression, itâ€™s called multiple linear regression. In R, to add another coefficient, add the symbol "+" for every additional variable you want to add to the model.

Linear model: `lm([target] ~ [predictor], data = [data source])`

## Data preparation
```{r}
mobility <- read.csv("mobility-all.csv", header = TRUE, stringsAsFactors = TRUE)
```

Drop all non-quantitative rows
```{r}
quals <- c("ID","Name", "State", "Latitude", "Longitude")

mobility <- mobility[,!(names(mobility) %in% quals)]
```

Drop low-quality columns
```{r}
print(colSums(is.na(mobility)))
```

```{r}
bad_cols <- c("Colleges","Tuition", "Graduation", "HS_dropout") # +100 NULL
mobility <- mobility[,!(names(mobility) %in% bad_cols)]
```

Drop remaining NULLS
```{r}
before <- nrow(mobility)
mobility <- drop_na(mobility)
dropped <- before - nrow(mobility)

print("Data reduced by: ")
print((dropped/before))
```

## Exploratory data analysis
```{r}
corrplot(cor(mobility),
         tl.col = "black",
         tl.cex = .5, 
         method = 'color')
```

### Social determinants of mobility
Goal: explore potential social determinants of mobility

Selected variables:
- segregation variables `Seg_racial`, `Seg_income`, `Seg_poverty`, and `Seg_affluence`
- educational variables `School_spending`, `Student_teacher_ratio`, and `Test_scores`
- family dynamic variables `Single_mothers`, `Divorced`

#### Segregation


```{r}
a <- ggplot(data = mobility, aes(x = Mobility, y = Seg_racial)) + 
  geom_point(color = "cornflowerblue", alpha = .3) + 
  #stat_smooth(method = "lm", formula = y ~ x, geom = "line", color = "darkorange") +
  stat_cor(label.x=.17, label.y=.5) +
  ggtitle("Race")
    
b <- ggplot(data = mobility, aes(x = Mobility, y = Seg_income)) + 
  geom_point(color = "skyblue", alpha = .3) +
  stat_cor(label.x=.17, label.y=.12) +
  ggtitle("Income")

c <- ggplot(data = mobility, aes(x = Mobility, y = Seg_poverty)) + 
  geom_point(color = "mediumseagreen", alpha = .3) +
  stat_cor(label.x=.17, label.y=.15) +
  ylim(0,.17) +
  ggtitle("Poverty") + 
  xlab("Mobility") + 
  ylab("Segregation") +
  theme(axis.title.x = element_text(hjust = 0),
        axis.title.y = element_text(angle=90, hjust = 0, margin = margin(r = 5)))

d <- ggplot(data = mobility, aes(x = Mobility, y = Seg_affluence)) + 
  geom_point(color = "seagreen", alpha = .3) +
  stat_cor(label.x=.17, label.y=.15) +
  ylim(0,.17) +
  ggtitle("Affluence") 

plot_row <- plot_grid(a,b,c,d, align = "hv")

title <- ggdraw() + 
  draw_label(
    "Segregation as a predictor of mobility",
    fontface = 'bold',
    x = 0,
    hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
plot_grid(
  title, plot_row,
  ncol = 1,
  rel_heights = c(0.1, 1)
)
```
Remove highly correlated variables:
```{r}
mobility <- mobility[,!(names(mobility) %in% c("Seg_income", "Seg_affluence", "Gini_99", "Share01"))]
```


#### Educational outcomes


```{r}
a <- ggplot(data = mobility, aes(x = Mobility, y = School_spending)) + 
  geom_point(color = "cornflowerblue", alpha = .3) + 
  #stat_smooth(method = "lm", formula = y ~ x, geom = "line", color = "darkorange") +
  stat_cor(label.x=.17, label.y=10.5) +
  ggtitle("School spending")
    
b <- ggplot(data = mobility, aes(x = Mobility, y = Student_teacher_ratio)) + 
  geom_point(color = "skyblue", alpha = .3) +
  stat_cor(label.x=.17, label.y=22, label.size = 0.05) +
  ggtitle("Student teacher ratio")

plot_row <- plot_grid(a,b, align = "hv")

title <- ggdraw() + 
  draw_label(
    "Educational factors associated with mobility",
    fontface = 'bold',
    x = 0,
    hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 7))
plot_grid(
  title, plot_row,
  ncol = 1,
  rel_heights = c(0.1, 1)
)
```

## Modeling

```{r}
lm.1 <- lm(formula = Mobility ~ ., 
   data = mobility)

summary(lm.1)
```
Extract highly correlated variables:

- `Black`
- `Seg_racial`
- `Commute`
- `Gini`
- `Middle_class`
- `Progressivity`
- `Manufacturing`
- `Migration_in`
- `Religious`
- `Violent_crime`
- `Single mothers`
- `Divorced`

```{r}

```

